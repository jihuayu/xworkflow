name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-build
          save-if: ${{ github.ref == 'refs/heads/master' }}

      - name: Run unit tests
        run: cargo test --no-fail-fast --all-features --workspace --lib --bins

      - name: Run doc tests
        run: cargo test --no-fail-fast --all-features --workspace --doc

      - name: Run integration tests
        run: |
          cargo test --no-fail-fast --all-features --workspace --test integration_tests
          cargo test --no-fail-fast --all-features --workspace --test plugin_system_registry
          cargo test --no-fail-fast --all-features --workspace --test plugin_system_tests

      - name: Run memory tests (single-thread)
        run: cargo test --no-fail-fast --all-features --workspace --test memory_tests -- --test-threads=1

  bench:
    name: Benchmark
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-build
          save-if: ${{ github.ref == 'refs/heads/master' }}

      - name: Restore benchmark baseline
        uses: actions/cache/restore@v4
        with:
          path: target/criterion
          key: criterion-${{ runner.os }}-master-not-exists
          restore-keys: |
            criterion-${{ runner.os }}-master

      - name: Run benchmarks
        run: cargo bench --all-features 2>&1 | tee bench_output.txt

      - name: Save benchmark baseline
        if: github.ref == 'refs/heads/master'
        uses: actions/cache/save@v4
        with:
          path: target/criterion
          key: criterion-${{ runner.os }}-master-${{ github.sha }}

      - name: Output benchmark results
        if: always()
        run: |
          echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "change:.*< " bench_output.txt; then
            echo "### Performance Changes (vs baseline)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -B 2 -A 1 "change:.*< " bench_output.txt | grep -v "^--$" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          elif grep -q "change:" bench_output.txt; then
            echo "> All changes within noise threshold (not statistically significant)." >> $GITHUB_STEP_SUMMARY
          else
            echo "> No baseline found. This run establishes the initial baseline." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "^Found.*outlier" bench_output.txt; then
            echo "### Outliers" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            awk '/time:/ {bench=$0} /^Found.*outlier/ {print bench; found=1} found && /^Found|^  / {print} found && !/^Found/ && !/^  / {found=0; print ""}' bench_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full Output" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '<details><summary>Click to expand</summary>' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat bench_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '</details>' >> $GITHUB_STEP_SUMMARY
